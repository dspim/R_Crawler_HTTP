---
title: "HTTP request"
author: "chihchengliang"
date: "2015年12月06日"
output:
  ioslides_presentation:
    css: css/dsp.css
    self_contained: no
    widescreen: yes
  html_document:
    theme: readable
---

## Agenda

### HTTP request
### Session / cookies


# HTTP request


## 了解 HTTP 請求很重要

- rvest 讓我們模仿使用瀏覽器的方式造訪網站，取得表格與表單
- 親自發出HTTP請求的使用情境仍然很多
- 例如：API的文件會註明使用何種 HTTP 請求方式取得資料

## 客戶端透過「動詞」與「URI」和伺服器請求服務

<img src="img/request_response.png" style="width:80%">


<div class="notes">

- HTTP 是機器在網路上溝通的方式
- 伺服器提供服務。例如：Google機房的伺服器提供搜尋服務。
- 客戶端請求服務。例如：你的電腦（客戶端）透過瀏覽器或R程式向Google伺服器請求搜尋服務。
- 常用的動詞`GET`(90%)、`POST`(9%) （其他你幾乎看不到了）
- URI代表資源位置。

> 瀏覽器使用動詞 `GET`對伺服器請求 URI `/`。伺服器回應200，並傳回html文件。

</div>

## 用 HTTP 請求取得資策會 SER API 資料

- Demo site: [SER API](http://api.ser.ideas.iii.org.tw/docs/#!/fb_fanpage_search)

<img src="img/API_doc.png" style="height:300px">

## 使用 httr套件

```{r}
library(httr)
```

- httr::POST
- httr::GET

## GET把所有請求參數放在URL裡

```{r}

res = httr::GET("http://api.ser.ideas.iii.org.tw:80/api/lbs_restaurant/restaurant_city_search?city=%E5%8F%B0%E5%8C%97%E5%B8%82&type=%E7%95%B0%E5%9C%8B%E6%96%99%E7%90%86&sort=score&token=api_doc_token&limit=5")

# 用content取出回傳的內容
content(res)
```

## 用神奇的magrittr語法讓程式變漂亮吧

```{r}
library(magrittr)
res %>% content %>% str
```


## POST 的請求參數以 list 放在 body 中

```{r}

res = httr::POST(
  url = "http://api.ser.ideas.iii.org.tw:80/api/fb_checkin_search",
  body = list(
    coordinates="25.041399,121.554233",
    radius="0.1",
    token = "api_doc_token"), 
  encode = "form")

res %>% content %>% str

```


## 背景知識

深入了解HTTP協定URLs、Verbs、Status Codes、Request and Response Message Formats

# Session / cookies

## 為什麼要知道 cookies

- Cookies：瀏覽器的變數，用來簡單記錄使用者的狀態
- Session：

- rvest::html_session

## 如何繞過 Ptt 八卦版18禁詢問頁面

```{r message=FALSE}
library(rvest)
read_html("https://www.ptt.cc/bbs/Gossiping/index.html") %>% html_text(trim = T)
```

## 使用rvest的session物件記錄cookie

```{r}
session = rvest::html_session(url = "https://www.ptt.cc/bbs/Gossiping/index.html")

form = session %>%
  html_node("form") %>%
  html_form()

session_redirected = rvest::submit_form(session = session, form = form )
```

## 在重導向的Session物件中取得資料

```{r}
session_redirected %>%
  html_node("body") %>%
  html_nodes(".title") %>%
  html_text(trim=T)

```

## Session幫我們保留了Cookie

```{r}
library(knitr)
session_redirected %>% cookies %>% kable
```


## References

- [httr quickstart guide](https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html)